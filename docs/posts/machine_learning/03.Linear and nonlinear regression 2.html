<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Qingsen Zhang">
<meta name="dcterms.date" content="2023-11-16">
<meta name="description" content="Implement my own version of linear regression and logistic regression and construct a time series momentum strategy based on my models in stock market. Phrase II, momentum strategy">

<title>Harnessing Momentum: Predictive Analysis of Stock Prices Using Linear and Nonlinear Regression II – Home</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-9f447091f8b1454dcd9b1558d5056ce7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Home</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ZhangQingsen/Blogs"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page">
      <h1 class="title">Harnessing Momentum: Predictive Analysis of Stock Prices Using Linear and Nonlinear Regression II</h1>
                  <div>
        <div class="description">
          Implement my own version of linear regression and logistic regression and construct a time series momentum strategy based on my models in stock market. Phrase II, momentum strategy
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Python</div>
                <div class="quarto-category">CS5805 23Fall</div>
                <div class="quarto-category">Machine Learning</div>
                <div class="quarto-category">Linear Regression</div>
                <div class="quarto-category">Nonlinear Regression</div>
                <div class="quarto-category">Momentum Strategy</div>
                <div class="quarto-category">Stock Prediction</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta column-page">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Qingsen Zhang </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 16, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block column-page" id="quarto-document-content">





<p>Continue from previous blog</p>
<section id="necessary-packages" class="level4">
<h4 class="anchored" data-anchor-id="necessary-packages"><strong>Necessary Packages</strong></h4>
<div id="bc787a9d" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MinMaxScaler, StandardScaler</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
</section>
<section id="copy-previous-code" class="level1">
<h1>copy previous code</h1>
<hr>
<hr>
</section>
<section id="end" class="level1">
<h1>end</h1>
<hr>
<section id="data-process" class="level3">
<h3 class="anchored" data-anchor-id="data-process">Data Process</h3>
<section id="download-data" class="level4">
<h4 class="anchored" data-anchor-id="download-data"><strong>Download Data</strong></h4>
<p>Here we download the price data of the stock</p>
<div id="9c830d79" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stock = 'AAPL'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>stock <span class="op">=</span> <span class="st">'GOOGL'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>period <span class="op">=</span> <span class="st">'1d'</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> <span class="st">'2000-1-1'</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>end <span class="op">=</span> <span class="st">'2022-12-31'</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>tickerData <span class="op">=</span> yf.Ticker(stock)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>tickerDf <span class="op">=</span> tickerData.history(period<span class="op">=</span>period, start<span class="op">=</span>start, end<span class="op">=</span>end)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>tickerDf.index <span class="op">=</span> pd.to_datetime(tickerDf.index)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span>tickerDf<span class="sc">.</span>isna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> missing values"</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>tickerDf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>There are 0 missing values</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Open</th>
<th data-quarto-table-cell-role="th">High</th>
<th data-quarto-table-cell-role="th">Low</th>
<th data-quarto-table-cell-role="th">Close</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">Dividends</th>
<th data-quarto-table-cell-role="th">Stock Splits</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2004-08-19 00:00:00-04:00</td>
<td>2.493464</td>
<td>2.594698</td>
<td>2.392727</td>
<td>2.501941</td>
<td>893181924</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2004-08-20 00:00:00-04:00</td>
<td>2.518648</td>
<td>2.719870</td>
<td>2.505931</td>
<td>2.700670</td>
<td>456686856</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2004-08-23 00:00:00-04:00</td>
<td>2.761511</td>
<td>2.829582</td>
<td>2.719122</td>
<td>2.727849</td>
<td>365122512</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2004-08-24 00:00:00-04:00</td>
<td>2.773729</td>
<td>2.782705</td>
<td>2.582480</td>
<td>2.614895</td>
<td>304946748</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2004-08-25 00:00:00-04:00</td>
<td>2.617140</td>
<td>2.692941</td>
<td>2.590210</td>
<td>2.643072</td>
<td>183772044</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-12-23 00:00:00-05:00</td>
<td>86.795362</td>
<td>89.226551</td>
<td>86.755505</td>
<td>88.907707</td>
<td>23003000</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2022-12-27 00:00:00-05:00</td>
<td>88.479259</td>
<td>88.618753</td>
<td>86.695724</td>
<td>87.074348</td>
<td>20097300</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-12-28 00:00:00-05:00</td>
<td>86.665836</td>
<td>87.722005</td>
<td>85.629592</td>
<td>85.709297</td>
<td>19523200</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2022-12-29 00:00:00-05:00</td>
<td>86.307132</td>
<td>88.529073</td>
<td>86.297166</td>
<td>88.130516</td>
<td>23333500</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-12-30 00:00:00-05:00</td>
<td>86.665831</td>
<td>87.981063</td>
<td>86.257308</td>
<td>87.911316</td>
<td>23986300</td>
<td>0.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

<p>4625 rows × 7 columns</p>
</div>
</div>
</div>
</section>
<section id="present-data" class="level4">
<h4 class="anchored" data-anchor-id="present-data"><strong>Present Data</strong></h4>
<div id="c6c25737" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>close_arr <span class="op">=</span> tickerDf[<span class="st">'Close'</span>]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>plt.plot(close_arr.index, close_arr, label<span class="op">=</span>stock)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkred'</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Price($)"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkred'</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"</span><span class="sc">{</span>stock<span class="sc">}</span><span class="ss"> price VS. Date"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkblue'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>plt.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03.Linear and nonlinear regression 2_files/figure-html/cell-6-output-1.png" width="596" height="472" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="present-cumulative-return" class="level4">
<h4 class="anchored" data-anchor-id="present-cumulative-return"><strong>Present Cumulative Return</strong></h4>
<p><font color="#e8b004"><strong><span class="math inline">\(return = \frac{Current\;price\;-\;Original\;price}{Original\;price}\)</span></strong></font></p>
<div id="93ea9968" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>return_arr <span class="op">=</span> tickerDf[<span class="st">'Close'</span>].pct_change().dropna()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>return_arr <span class="op">=</span> (<span class="dv">1</span><span class="op">+</span>return_arr).cumprod()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>plt.plot(return_arr.index, return_arr, label<span class="op">=</span>stock)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkred'</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative</span><span class="ch">\n</span><span class="st">Return"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkred'</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"</span><span class="sc">{</span>stock<span class="sc">}</span><span class="ss"> return VS. Date"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkblue'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>plt.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03.Linear and nonlinear regression 2_files/figure-html/cell-7-output-1.png" width="605" height="472" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Therefore, if we trade the stock everyday, and ignore the trading fee, this is how the principal (initial amount of investment) growth during this peroid.</p>
</section>
<section id="retrieve-factors" class="level4">
<h4 class="anchored" data-anchor-id="retrieve-factors"><strong>Retrieve Factors</strong></h4>
<p>Look at the product of returns which to capture momentum effects.<br>
Notice that there are about 252 trading days in one year.</p>
<ul>
<li><p><strong>day_momentum:</strong> This is the one-day lagged return. It measures the momentum from the previous day.</p></li>
<li><p><strong>week_momentum:</strong> This is the product of the past 5 days’ returns, shifted forward by one day. It measures the momentum from the past week.</p></li>
<li><p><strong>month_momentum:</strong> This is the product of the past 21 days’ returns, shifted forward by one day. It measures the momentum from the past month.</p></li>
<li><p><strong>quarter_momentum:</strong> This is the product of the past 63 days’ returns, shifted forward by one day. It measures the momentum from the past quarter.</p></li>
<li><p><strong>year_momentum:</strong> This is the product of the past 252 days’ returns, shifted forward by one day. It measures the momentum from the past year.</p></li>
<li><p><strong>52_weeks_high_low_ratio:</strong> This is the ratio of the difference between the current close price and the 52-week low to the range of the 52-week high and low. It measures how close the current price is to the 52-week high relative to the 52-week range.</p></li>
</ul>
<p><strong>52-week high:<strong>The 52-week high momentum strategy is a trading strategy where investors go long or short on a stock when its current price is near (or far from) its 52-week high. This can be measured using the formula:<br>
<font color="#e8b004" size="10"></font></strong><font color="#e8b004" size="10"><span class="math inline">\(\frac{P_{(i, t-1)}}{High_{(i,t-1)}}\)</span></font></strong><br>
where<font color="#5bae23"><strong><span class="math inline">\(P_{(i, t-1)}\)</span></strong></font> is is the price of the stock at time t−1, and <font color="#5bae23"><strong><span class="math inline">\(High_{(i,t-1)}\)</span></strong></font> is the highest price the stock reached in the past 52 weeks.</p>
<div id="3e3c62ff" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'return'</span>] <span class="op">=</span> tickerDf[<span class="st">'Close'</span>].pct_change()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure not using today's data to predict today's result</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'day_momentum'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">'return'</span>]).shift(<span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'week_momentum'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">'return'</span>]).rolling(window<span class="op">=</span><span class="dv">5</span>).<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>).shift(<span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'month_momentum'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">'return'</span>]).rolling(window<span class="op">=</span><span class="dv">21</span>).<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>).shift(<span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'quarter_momentum'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">'return'</span>]).rolling(window<span class="op">=</span><span class="dv">63</span>).<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>).shift(<span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'year_momentum'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">'return'</span>]).rolling(window<span class="op">=</span><span class="dv">252</span>).<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>).shift(<span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'52_weeks_high_low_ratio'</span>] <span class="op">=</span> (tickerDf[<span class="st">'Close'</span>] <span class="op">-</span> tickerDf[<span class="st">'Low'</span>].rolling(window<span class="op">=</span><span class="dv">252</span>).<span class="bu">min</span>()) <span class="op">/</span> (tickerDf[<span class="st">'High'</span>].rolling(window<span class="op">=</span><span class="dv">252</span>).<span class="bu">max</span>() <span class="op">-</span> tickerDf[<span class="st">'Low'</span>].rolling(window<span class="op">=</span><span class="dv">252</span>).<span class="bu">min</span>())</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">day_momentum</th>
<th data-quarto-table-cell-role="th">week_momentum</th>
<th data-quarto-table-cell-role="th">month_momentum</th>
<th data-quarto-table-cell-role="th">quarter_momentum</th>
<th data-quarto-table-cell-role="th">year_momentum</th>
<th data-quarto-table-cell-role="th">52_weeks_high_low_ratio</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2004-08-19 00:00:00-04:00</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2004-08-20 00:00:00-04:00</td>
<td>0.079430</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2004-08-23 00:00:00-04:00</td>
<td>0.010064</td>
<td>0.079430</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2004-08-24 00:00:00-04:00</td>
<td>-0.041408</td>
<td>0.010064</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2004-08-25 00:00:00-04:00</td>
<td>0.010776</td>
<td>-0.041408</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-12-23 00:00:00-05:00</td>
<td>0.016750</td>
<td>-0.020317</td>
<td>-0.034118</td>
<td>-0.095724</td>
<td>-0.111201</td>
<td>-0.400608</td>
<td>0.086355</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2022-12-27 00:00:00-05:00</td>
<td>-0.020621</td>
<td>0.016750</td>
<td>-0.011411</td>
<td>-0.093744</td>
<td>-0.091066</td>
<td>-0.392648</td>
<td>0.059379</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-12-28 00:00:00-05:00</td>
<td>-0.015677</td>
<td>-0.020621</td>
<td>-0.011872</td>
<td>-0.103324</td>
<td>-0.103692</td>
<td>-0.409154</td>
<td>0.039292</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2022-12-29 00:00:00-05:00</td>
<td>0.028249</td>
<td>-0.015677</td>
<td>-0.033700</td>
<td>-0.104425</td>
<td>-0.140230</td>
<td>-0.413581</td>
<td>0.074920</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-12-30 00:00:00-05:00</td>
<td>-0.002487</td>
<td>0.028249</td>
<td>-0.012614</td>
<td>-0.070806</td>
<td>-0.092076</td>
<td>-0.396884</td>
<td>0.071694</td>
</tr>
</tbody>
</table>

<p>4625 rows × 7 columns</p>
</div>
</div>
</div>
</section>
<section id="improve-factors" class="level4">
<h4 class="anchored" data-anchor-id="improve-factors">Improve Factors</h4>
<ul>
<li><p><strong>Smoothing:</strong> Smoothing the momentum calculations with a moving average to reduce noise.</p></li>
<li><p><strong>Risk adjustment:</strong> Adjust the momentum calculations for risk. Divide the momentum by the standard deviation (volatility) of returns over the past year to get a risk-adjusted momentum measure.</p></li>
</ul>
<div id="adc2405f" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Smoothing with a moving average</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'day_momentum_smooth'</span>] <span class="op">=</span> df[<span class="st">'day_momentum'</span>].rolling(window<span class="op">=</span><span class="dv">5</span>).mean()</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'week_momentum_smooth'</span>] <span class="op">=</span> df[<span class="st">'week_momentum'</span>].rolling(window<span class="op">=</span><span class="dv">5</span>).mean()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'month_momentum_smooth'</span>] <span class="op">=</span> df[<span class="st">'month_momentum'</span>].rolling(window<span class="op">=</span><span class="dv">5</span>).mean()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'quarter_momentum_smooth'</span>] <span class="op">=</span> df[<span class="st">'quarter_momentum'</span>].rolling(window<span class="op">=</span><span class="dv">5</span>).mean()</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'year_momentum_smooth'</span>] <span class="op">=</span> df[<span class="st">'year_momentum'</span>].rolling(window<span class="op">=</span><span class="dv">5</span>).mean()</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Risk adjustment</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'day_momentum_risk_adj'</span>] <span class="op">=</span> df[<span class="st">'day_momentum'</span>] <span class="op">/</span> df[<span class="st">'return'</span>].rolling(window<span class="op">=</span><span class="dv">252</span>).std()</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'week_momentum_risk_adj'</span>] <span class="op">=</span> df[<span class="st">'week_momentum'</span>] <span class="op">/</span> df[<span class="st">'return'</span>].rolling(window<span class="op">=</span><span class="dv">252</span>).std()</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'month_momentum_risk_adj'</span>] <span class="op">=</span> df[<span class="st">'month_momentum'</span>] <span class="op">/</span> df[<span class="st">'return'</span>].rolling(window<span class="op">=</span><span class="dv">252</span>).std()</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'quarter_momentum_risk_adj'</span>] <span class="op">=</span> df[<span class="st">'quarter_momentum'</span>] <span class="op">/</span> df[<span class="st">'return'</span>].rolling(window<span class="op">=</span><span class="dv">252</span>).std()</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'year_momentum_risk_adj'</span>] <span class="op">=</span> df[<span class="st">'year_momentum'</span>] <span class="op">/</span> df[<span class="st">'return'</span>].rolling(window<span class="op">=</span><span class="dv">252</span>).std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="normalize-or-standardize-the-factors" class="level4">
<h4 class="anchored" data-anchor-id="normalize-or-standardize-the-factors"><strong>Normalize or Standardize the factors</strong></h4>
<div id="2cba099a" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scaler = MinMaxScaler()</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>df_scaled <span class="op">=</span> df.dropna()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>return_arr <span class="op">=</span> df_scaled[<span class="st">'return'</span>]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>df_scaled <span class="op">=</span> df_scaled[df_scaled.columns[<span class="dv">1</span>:]]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>df_scaled <span class="op">=</span> pd.DataFrame(scaler.fit_transform(df_scaled), columns<span class="op">=</span>df.columns[<span class="dv">1</span>:])</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>df_scaled.set_index(return_arr.index, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>df_scaled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">day_momentum</th>
<th data-quarto-table-cell-role="th">week_momentum</th>
<th data-quarto-table-cell-role="th">month_momentum</th>
<th data-quarto-table-cell-role="th">quarter_momentum</th>
<th data-quarto-table-cell-role="th">year_momentum</th>
<th data-quarto-table-cell-role="th">52_weeks_high_low_ratio</th>
<th data-quarto-table-cell-role="th">day_momentum_smooth</th>
<th data-quarto-table-cell-role="th">week_momentum_smooth</th>
<th data-quarto-table-cell-role="th">month_momentum_smooth</th>
<th data-quarto-table-cell-role="th">quarter_momentum_smooth</th>
<th data-quarto-table-cell-role="th">year_momentum_smooth</th>
<th data-quarto-table-cell-role="th">day_momentum_risk_adj</th>
<th data-quarto-table-cell-role="th">week_momentum_risk_adj</th>
<th data-quarto-table-cell-role="th">month_momentum_risk_adj</th>
<th data-quarto-table-cell-role="th">quarter_momentum_risk_adj</th>
<th data-quarto-table-cell-role="th">year_momentum_risk_adj</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2005-08-25 00:00:00-04:00</td>
<td>0.526101</td>
<td>-0.310159</td>
<td>-0.747161</td>
<td>0.255181</td>
<td>4.249616</td>
<td>0.582602</td>
<td>-0.297115</td>
<td>-0.796104</td>
<td>-1.230024</td>
<td>0.490876</td>
<td>4.181518</td>
<td>0.363546</td>
<td>-0.248104</td>
<td>-0.599921</td>
<td>0.038821</td>
<td>2.899086</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2005-08-26 00:00:00-04:00</td>
<td>-0.036395</td>
<td>0.137104</td>
<td>-0.779209</td>
<td>0.303679</td>
<td>4.109359</td>
<td>0.599627</td>
<td>0.146940</td>
<td>-0.653592</td>
<td>-1.091964</td>
<td>0.374524</td>
<td>4.078954</td>
<td>-0.039405</td>
<td>0.063938</td>
<td>-0.623065</td>
<td>0.073998</td>
<td>2.797304</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2005-08-29 00:00:00-04:00</td>
<td>0.145343</td>
<td>0.223296</td>
<td>-0.602729</td>
<td>0.131622</td>
<td>4.266773</td>
<td>0.683375</td>
<td>0.232511</td>
<td>-0.373544</td>
<td>-0.903032</td>
<td>0.240200</td>
<td>4.130536</td>
<td>0.091656</td>
<td>0.125271</td>
<td>-0.499923</td>
<td>-0.047095</td>
<td>2.937002</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2005-08-30 00:00:00-04:00</td>
<td>0.869117</td>
<td>1.206299</td>
<td>-0.162035</td>
<td>-0.051974</td>
<td>4.732813</td>
<td>0.663083</td>
<td>1.184218</td>
<td>0.157565</td>
<td>-0.658245</td>
<td>0.193399</td>
<td>4.323529</td>
<td>0.613407</td>
<td>0.814936</td>
<td>-0.186947</td>
<td>-0.178942</td>
<td>3.292229</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2005-08-31 00:00:00-04:00</td>
<td>-0.256739</td>
<td>0.585828</td>
<td>-0.372427</td>
<td>-0.357314</td>
<td>4.668739</td>
<td>0.641242</td>
<td>0.581638</td>
<td>0.452240</td>
<td>-0.556264</td>
<td>0.056409</td>
<td>4.407314</td>
<td>-0.198508</td>
<td>0.380405</td>
<td>-0.336556</td>
<td>-0.398118</td>
<td>3.250346</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-12-23 00:00:00-05:00</td>
<td>-1.115871</td>
<td>-0.931893</td>
<td>-1.356665</td>
<td>-1.131539</td>
<td>-1.917170</td>
<td>-2.250567</td>
<td>-0.938168</td>
<td>-1.568035</td>
<td>-1.299998</td>
<td>-1.170135</td>
<td>-1.859593</td>
<td>-0.855957</td>
<td>-0.714465</td>
<td>-1.076112</td>
<td>-0.981907</td>
<td>-1.833808</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2022-12-27 00:00:00-05:00</td>
<td>0.846729</td>
<td>-0.372649</td>
<td>-1.332555</td>
<td>-0.988083</td>
<td>-1.893415</td>
<td>-2.352100</td>
<td>-0.361856</td>
<td>-1.469678</td>
<td>-1.317399</td>
<td>-1.122054</td>
<td>-1.870063</td>
<td>0.628240</td>
<td>-0.302470</td>
<td>-1.057323</td>
<td>-0.873379</td>
<td>-1.813853</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-12-28 00:00:00-05:00</td>
<td>-1.131958</td>
<td>-0.384004</td>
<td>-1.449202</td>
<td>-1.078039</td>
<td>-1.942674</td>
<td>-2.427698</td>
<td>-0.373133</td>
<td>-1.225993</td>
<td>-1.323680</td>
<td>-1.090390</td>
<td>-1.889887</td>
<td>-0.866907</td>
<td>-0.310713</td>
<td>-1.143680</td>
<td>-0.940787</td>
<td>-1.852811</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2022-12-29 00:00:00-05:00</td>
<td>-0.870185</td>
<td>-0.921592</td>
<td>-1.462599</td>
<td>-1.338362</td>
<td>-1.955887</td>
<td>-2.293609</td>
<td>-0.921831</td>
<td>-1.011914</td>
<td>-1.369715</td>
<td>-1.143779</td>
<td>-1.915115</td>
<td>-0.667247</td>
<td>-0.704124</td>
<td>-1.150777</td>
<td>-1.134300</td>
<td>-1.860391</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-12-30 00:00:00-05:00</td>
<td>1.455556</td>
<td>-0.402278</td>
<td>-1.053288</td>
<td>-0.995273</td>
<td>-1.906056</td>
<td>-2.305748</td>
<td>-0.379955</td>
<td>-0.739136</td>
<td>-1.389635</td>
<td>-1.124418</td>
<td>-1.927815</td>
<td>1.084413</td>
<td>-0.323457</td>
<td>-0.847154</td>
<td>-0.877042</td>
<td>-1.820619</td>
</tr>
</tbody>
</table>

<p>4368 rows × 16 columns</p>
</div>
</div>
</div>
<p>Let’s see if the factors are correlated to our target</p>
<div id="26d32721" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> e <span class="kw">in</span> df_scaled.columns:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  factor <span class="op">=</span> df_scaled[e]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  corr_coef <span class="op">=</span> np.corrcoef(factor, return_arr)[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> np.<span class="bu">abs</span>(corr_coef) <span class="op">&gt;</span> <span class="fl">0.1</span>:</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"The correlation coefficient between </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss"> and target is </span><span class="sc">{</span>corr_coef<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The correlation coefficient between 52_weeks_high_low_ratio and target is 0.13</code></pre>
</div>
</div>
<p>Predict the return as target y for linear regression, and predict net return (0 for positive, 1 for negative) as target for logistic regression.<br>
Split train-test datasets to evaluate the performance of each model.</p>
<div id="ff08b870" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df_scaled</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>y_linear <span class="op">=</span> return_arr</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>y_logistic <span class="op">=</span> normalize_and_binarize(return_arr)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>X_train_linear, X_test_linear, y_train_linear, y_test_linear <span class="op">=</span> train_test_split(X, y_linear, test_size<span class="op">=</span><span class="fl">0.3</span>, shuffle<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>X_train_logistic, X_test_logistic, y_train_logistic, y_test_logistic <span class="op">=</span> train_test_split(X, y_logistic, test_size<span class="op">=</span><span class="fl">0.3</span>, shuffle<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="training-the-models" class="level3">
<h3 class="anchored" data-anchor-id="training-the-models">Training the models</h3>
<section id="linear-model" class="level4">
<h4 class="anchored" data-anchor-id="linear-model">Linear model</h4>
<p>The result is shown in a barplot, where height=1 means y_pred and y_train are in the same direction, otherwise it is -1.</p>
<div id="c3dbc54e" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the linear model</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>learning_rate <span class="op">=</span> <span class="fl">0.00001</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>iterations <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>weights_linear, y_pred_linear, perform_df_linear <span class="op">=</span> fit_linear(X_train_linear.values, y_train_linear.values, lr<span class="op">=</span>learning_rate, num_iter<span class="op">=</span>iterations)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> my_rmse(y_train_linear.values, y_pred_linear)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>y_train_bin <span class="op">=</span> normalize_and_binarize(y_train_linear.values)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>y_pred_bin <span class="op">=</span> normalize_and_binarize(y_pred_linear)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>accu <span class="op">=</span> accuracy_score(y_train_bin, y_pred_bin)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final loss:</span><span class="sc">{</span>loss<span class="sc">:.2f}</span><span class="ss">, accuracy: </span><span class="sc">{</span>accu<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>x_axis <span class="op">=</span> X_train_linear.index</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>y_signal <span class="op">=</span> np.where(y_train_bin <span class="op">==</span> y_pred_bin, <span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>plt.bar(x_axis, y_signal)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkred'</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Prediction</span><span class="ch">\n</span><span class="st">Outcome"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkred'</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Performance in Linear regression Training"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkblue'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.legend()</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate the models</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co"># ... (depends on how you want to evaluate your models)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final loss:0.04, accuracy: 0.50</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03.Linear and nonlinear regression 2_files/figure-html/cell-13-output-2.png" width="631" height="472" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="logistic-model" class="level4">
<h4 class="anchored" data-anchor-id="logistic-model">Logistic model</h4>
<p>The result is shown in a barplot, where height=1 means y_pred and y_train are the same, otherwise it is -1.</p>
<div id="265dd0f7" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the logistic model</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>learning_rate <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>iterations <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>weights_logistic, h_pred_logistic, perform_df_logistic <span class="op">=</span> fit_logistic(X_train_logistic.values, y_train_logistic, lr<span class="op">=</span>learning_rate, num_iter<span class="op">=</span>iterations)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>y_pred_logistic <span class="op">=</span> normalize_and_binarize(h_pred_logistic)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> logLoss(y_train_logistic, h_pred_logistic)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>accu <span class="op">=</span> accuracy_score(y_train_logistic, y_pred_logistic)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final loss:</span><span class="sc">{</span>loss<span class="sc">:.2f}</span><span class="ss">, accuracy: </span><span class="sc">{</span>accu<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>x_axis <span class="op">=</span> X_train_logistic.index</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>y_signal <span class="op">=</span> np.where(y_train_logistic <span class="op">==</span> y_pred_logistic, <span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>plt.bar(x_axis, y_signal)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkred'</span>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Prediction</span><span class="ch">\n</span><span class="st">Outcome"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkred'</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Performance in Logistic regression Training"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkblue'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.legend()</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final loss:0.70, accuracy: 0.51</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03.Linear and nonlinear regression 2_files/figure-html/cell-14-output-2.png" width="631" height="472" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="test-the-performance-of-strategy-based-on-the-prediction" class="level3">
<h3 class="anchored" data-anchor-id="test-the-performance-of-strategy-based-on-the-prediction">Test the performance of Strategy based on the prediction</h3>
<p>When we predict the return to be negative, we want to short the stock, otherwise long it. This time we are performing the prediction on the test dataset.</p>
<div id="8ea01515" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>y_pred_linear <span class="op">=</span> linearPredict(X_test_linear, weights_linear)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>y_pred_logistic <span class="op">=</span> linearPredict(X_test_logistic, weights_logistic)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>test_return_arr <span class="op">=</span> y_test_linear</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the return</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>y_pred_linear_return <span class="op">=</span> np.where(y_pred_linear <span class="op">&gt;</span> <span class="dv">0</span>, test_return_arr, <span class="op">-</span>test_return_arr)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>y_pred_logistic_return <span class="op">=</span> np.where(y_pred_logistic <span class="op">&gt;</span> <span class="dv">0</span>, test_return_arr, <span class="op">-</span>test_return_arr)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>x_axis <span class="op">=</span> test_return_arr.index</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>cum_test_return <span class="op">=</span> (<span class="dv">1</span><span class="op">+</span>test_return_arr).cumprod()</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>cum_linear_return <span class="op">=</span> (<span class="dv">1</span><span class="op">+</span>y_pred_linear_return).cumprod()</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>cum_logistic_return <span class="op">=</span> (<span class="dv">1</span><span class="op">+</span>y_pred_logistic_return).cumprod()</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>plt.plot(x_axis, cum_test_return, label<span class="op">=</span><span class="st">'test_return'</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>plt.plot(x_axis, cum_linear_return, label<span class="op">=</span><span class="st">'linear_return'</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>plt.plot(x_axis, cum_logistic_return, label<span class="op">=</span><span class="st">'logistic_return'</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkred'</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative</span><span class="ch">\n</span><span class="st">Return"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkred'</span>)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Strategy comparison on testset"</span>, fontname<span class="op">=</span><span class="st">'serif'</span>, color<span class="op">=</span><span class="st">'darkblue'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03.Linear and nonlinear regression 2_files/figure-html/cell-15-output-1.png" width="609" height="471" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This shows the comparison among strategies, and the logistic regression predicted strategy seems shows the best performance. However, this project ignore the transaction fee, which could be very large for trading everyday. Future work could analysis the performance among strategies among differet trading frequences, e.g.&nbsp;make transaction every week, month, quarter, or year.</p>
<p>end.</p>
<p><a href="../../posts/machine_learning/03.Linear and nonlinear regression 1.html">previous</a><br>
<a href="../../posts/machine_learning/machine_learning.html">go back</a></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/zhangqingsen\.github\.io\/Blogs\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>